## QUESTION 1: How many users do we have?
# ANSWER: 130

SELECT 
    COUNT( DISTINCT USER_ID)
FROM DEV_DB.DBT_NIMAAREF6GMAILCOM.STG_POSTGRES__USERS; 

## QUESTION 2: On average, how mamy order do we receive per hour?
# ANSWER: Approximately 7.5 orders per hour.

WITH order_hour as (
SELECT 
    DATE_TRUNC(HOUR, CREATED_AT) AS ORDER_HOUR, 
    COUNT(DISTINCT ORDER_ID) AS ORDER_COUNT
FROM DEV_DB.DBT_NIMAAREF6GMAILCOM.STG_POSTGRES__ORDERS
GROUP BY DATE_TRUNC(HOUR, CREATED_AT)
)

SELECT AVG(ORDER_COUNT) AS AVG_ORDERS_PER_HOUR
FROM ORDER_HOUR ;


## QUESTION 3: On average, how long does an order take from being placed to being delivered?
# ANSWER: 3.9 days on average.

with order_delivery_days as (
SELECT  
    ORDER_ID,
DATEDIFF(DAY,MIN(CREATED_AT),MIN(DELIVERED_AT)) AS DELIVERY_TIME
    
FROM DEV_DB.DBT_NIMAAREF6GMAILCOM.STG_POSTGRES__ORDERS
GROUP BY ORDER_ID
) 

select 
avg(delivery_time) 
from order_delivery_days;

## QUESTION 4: How many users have only made one purchase? Two purchases? Three+ purchases?
# ANSWER: Single: 25, Two: 28, Three +: 71

with user_orders as(

SELECT 
    USER_ID,
    COUNT(DISTINCT ORDER_ID) AS ORDER_COUNT
FROM DEV_DB.DBT_NIMAAREF6GMAILCOM.STG_POSTGRES__ORDERS
GROUP BY USER_ID
ORDER BY COUNT(DISTINCT ORDER_ID) DESC
) 

SELECT 
    COUNT(CASE WHEN ORDER_COUNT = 1 THEN USER_ID END) AS SINGLE_PURCHASE,
    COUNT(CASE WHEN ORDER_COUNT = 2 THEN USER_ID END) AS TWO_PURCHASES,
    COUNT(CASE WHEN ORDER_COUNT>= 3 THEN USER_ID END) AS THREE_OR_MORE_PURCHASES
FROM user_orders;


## QUESTION 5: On average, how many unique sessions do we have per hour?
# ANSWER: Approximately 16.3 sessions per hour.

WITH session_hour as (
SELECT 
    DATE_TRUNC(HOUR, CREATED_AT) AS ORDER_HOUR, 
    COUNT(DISTINCT SESSION_ID) AS SESSION_COUNT
FROM DEV_DB.DBT_NIMAAREF6GMAILCOM.STG_POSTGRES__EVENTS
GROUP BY DATE_TRUNC(HOUR, CREATED_AT)
)

SELECT AVG(SESSION_COUNT) AS AVG_SESSIONS_PER_HOUR
FROM session_hour ;
    